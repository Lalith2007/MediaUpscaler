{% extends "base.html" %}

{% block title %}Frame Interpolator - PixelForge{% endblock %}

{% block nav_extra %}{% endblock %}

{% block content_style %}
  /* Frame Interpolator page specific styles */
  #three-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }
  .fi-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
    z-index: 1;
  }
  .fi-header {
    text-align: center;
    margin-bottom: 60px;
    opacity: 0;
  }
  .fi-header h1 {
    font-size: 4rem;
    background: linear-gradient(135deg, #00d4ff, #ff00ff, #00ff88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
    font-weight: 900;
  }
  .fi-subtitle {
    font-size: 1.3rem;
    color: #00d4ff;
    opacity: 0.8;
  }
  .fi-features {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 50px;
  }
  .fi-feature-card {
    background: rgba(0, 212, 255, 0.05);
    border: 1px solid rgba(0, 212, 255, 0.3);
    padding: 30px;
    border-radius: 20px;
    backdrop-filter: blur(20px);
    transform: translateY(50px);
    opacity: 0;
    transition: all 0.3s;
  }
  .fi-feature-card:hover {
    transform: translateY(-10px) !important;
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.15);
    box-shadow: 0 20px 60px rgba(0, 212, 255, 0.3);
  }
  .fi-feature-icon { font-size: 3rem; margin-bottom: 15px; }
  .fi-feature-card h3 { color: #00d4ff; margin-bottom: 10px; }

  .fi-upload-section {
    background: rgba(255, 255, 255, 0.03);
    border: 2px dashed rgba(0, 212, 255, 0.4);
    border-radius: 25px;
    padding: 80px 40px;
    text-align: center;
    margin-bottom: 40px;
    transform: scale(0.9);
    opacity: 0;
    transition: all 0.3s;
  }
  .fi-upload-section:hover {
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.08);
    transform: scale(1) !important;
  }
  .fi-upload-icon { font-size: 5rem; margin-bottom: 20px; }
  .fi-upload-btn {
    background: linear-gradient(135deg, #00d4ff, #0099ff);
    color: #000;
    padding: 18px 50px;
    border: none;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 10px 40px rgba(0, 212, 255, 0.4);
  }
  .fi-upload-input { display: none; }

  .fi-settings {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 0, 255, 0.1));
    border: 1px solid rgba(0, 212, 255, 0.3);
    padding: 40px;
    border-radius: 25px;
    backdrop-filter: blur(30px);
    display: none;
    transform: translateY(30px);
    opacity: 0;
  }
  .fi-settings.active { display: block; animation: fi-slideUp 0.5s forwards; }
  @keyframes fi-slideUp { to { transform: translateY(0); opacity: 1; } }

  .fi-fps-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 30px 0;
  }
  .fi-fps-option {
    padding: 20px;
    border: 2px solid rgba(0, 212, 255, 0.4);
    border-radius: 15px;
    cursor: pointer;
    text-align: center;
    font-weight: 700;
    font-size: 1.2rem;
    transition: all 0.3s;
    background: rgba(0, 0, 0, 0.3);
  }
  .fi-fps-option:hover { border-color: #00d4ff; transform: scale(1.05); }
  .fi-fps-option.selected {
    background: linear-gradient(135deg, #00d4ff, #0099ff);
    color: #000;
    border-color: #00d4ff;
    box-shadow: 0 0 30px rgba(0, 212, 255, 0.6);
  }

  .fi-process-btn {
    width: 100%;
    padding: 22px;
    background: linear-gradient(135deg, #ff00ff, #00d4ff);
    color: #fff;
    border: none;
    border-radius: 15px;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 10px 40px rgba(255, 0, 255, 0.4);
    transition: all 0.3s;
  }
  .fi-process-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 15px 50px rgba(255, 0, 255, 0.6);
  }
  .fi-process-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .fi-progress-section { display: none; margin-top: 30px; }
  .fi-progress-section.active { display: block; animation: fi-fadeIn 0.5s; }
  @keyframes fi-fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .fi-progress-bar {
    width: 100%;
    height: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    margin: 20px 0;
  }
  .fi-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00d4ff, #ff00ff, #00ff88);
    width: 0%;
    transition: width 0.3s;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
  }
  .fi-file-info {
    background: rgba(0, 212, 255, 0.15);
    border-left: 4px solid #00d4ff;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
  }

  .fi-download-section { display: none; text-align: center; margin-top: 40px; }
  .fi-download-section.active { display: block; animation: fi-bounceIn 0.8s; }
  @keyframes fi-bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }
  .fi-download-btn {
    background: linear-gradient(135deg, #00ff88, #00d4ff);
    color: #000;
    padding: 22px 60px;
    border: none;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 10px 40px rgba(0, 255, 136, 0.4);
  }

  @media (max-width: 768px) {
    .fi-header h1 { font-size: 2.5rem; }
    .fi-features, .fi-fps-selector { grid-template-columns: 1fr; }
  }
{% endblock %}

{% block content %}
  <canvas id="three-canvas"></canvas>

  <div class="fi-container">
    <header class="fi-header">
      <h1>üé¨ Frame Interpolator</h1>
      <p class="fi-subtitle">AI-Powered Motion Interpolation</p>
    </header>

    <div class="fi-features">
      <div class="fi-feature-card">
        <div class="fi-feature-icon">‚ö°</div>
        <h3>Lightning Fast</h3>
        <p>Process videos in seconds</p>
      </div>
      <div class="fi-feature-card">
        <div class="fi-feature-icon">üéØ</div>
        <h3>Optical Flow AI</h3>
        <p>Smart frame generation</p>
      </div>
      <div class="fi-feature-card">
        <div class="fi-feature-icon">üöÄ</div>
        <h3>Up to 240 FPS</h3>
        <p>Ultra smooth motion</p>
      </div>
    </div>

    <div class="fi-upload-section">
      <div class="fi-upload-icon">üìπ</div>
      <h2>Drop Your Video Here</h2>
      <p style="margin: 10px 0 30px;">Max 5 minutes, any format</p>
      <input type="file" id="videoInput" class="fi-upload-input" accept="video/*">
      <button class="fi-upload-btn" id="uploadBtn">Select Video</button>
      <div class="fi-file-info" id="fileInfo" style="display:none;"></div>
    </div>

    <div class="fi-settings" id="settingsSection">
      <h3 style="color: #00d4ff; margin-bottom: 20px;">üéØ Target Frame Rate</h3>
      <div class="fi-fps-selector">
        <div class="fi-fps-option" data-fps="60">60 FPS<br><small>Smooth</small></div>
        <div class="fi-fps-option" data-fps="120">120 FPS<br><small>Silky</small></div>
        <div class="fi-fps-option selected" data-fps="240">240 FPS<br><small>Ultra</small></div>
      </div>

      <button class="fi-process-btn" id="processBtn">üöÄ Start Processing</button>

      <div class="fi-progress-section" id="progressSection">
        <div class="fi-file-info" id="processingStatus">Processing...</div>
        <div class="fi-progress-bar">
          <div class="fi-progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText" style="text-align: center; font-size: 1.2rem;">0%</p>
      </div>

      <div class="fi-download-section" id="downloadSection">
        <h2 style="color: #00ff88; margin-bottom: 30px;">‚úÖ Processing Complete!</h2>
        <button class="fi-download-btn" id="downloadBtn">‚¨áÔ∏è Download Video</button>
      </div>
    </div>
  </div>

  <script>
    // Three.js 3D Background
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    const renderer = new THREE.WebGLRenderer({
      canvas: document.getElementById('three-canvas'),
      alpha: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.position.z = 5;

    const geometry = new THREE.TorusGeometry(10, 3, 16, 100);
    const material = new THREE.MeshBasicMaterial({ color: 0x00d4ff, wireframe: true });
    const torus = new THREE.Mesh(geometry, material);
    scene.add(torus);

    const particles = new THREE.BufferGeometry();
    const particleCount = 1000;
    const positions = new Float32Array(particleCount * 3);
    for (let i = 0; i < particleCount * 3; i++) {
      positions[i] = (Math.random() - 0.5) * 100;
    }
    particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const particleMaterial = new THREE.PointsMaterial({ color: 0x00d4ff, size: 0.1 });
    const particleSystem = new THREE.Points(particles, particleMaterial);
    scene.add(particleSystem);

    function animate() {
      requestAnimationFrame(animate);
      torus.rotation.x += 0.005;
      torus.rotation.y += 0.01;
      particleSystem.rotation.y += 0.001;
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // GSAP Animations
    gsap.to('.fi-header', { opacity: 1, y: 0, duration: 1, delay: 0.2 });
    gsap.to('.fi-feature-card', {
      opacity: 1,
      y: 0,
      duration: 0.8,
      stagger: 0.2,
      delay: 0.5
    });
    gsap.to('.fi-upload-section', { opacity: 1, scale: 1, duration: 0.8, delay: 1 });

    // Functionality
    const socket = io('http://localhost:5001');
    let selectedFile = null,
        selectedFps = 240,
        processedVideoB64 = null,
        processedFilename = null,
        jobId = null;

    document.getElementById('uploadBtn').onclick = () =>
      document.getElementById('videoInput').click();

    document.getElementById('videoInput').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        document.getElementById('fileInfo').innerHTML =
          '<strong>üìÅ File:</strong> ' + file.name +
          '<br><strong>üìä Size:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB';
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('settingsSection').classList.add('active');
        gsap.to('#settingsSection', { opacity: 1, y: 0, duration: 0.5 });
      }
    };

    document.querySelectorAll('.fi-fps-option').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.fi-fps-option').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        selectedFps = parseInt(this.dataset.fps);
        gsap.from(this, { scale: 1.2, duration: 0.3 });
      };
    });

    document.getElementById('processBtn').onclick = async () => {
      if (!selectedFile) return alert('Select a video first!');
      jobId = 'job_' + Date.now();
      const formData = new FormData();
      formData.append('video', selectedFile);
      formData.append('target_fps', selectedFps);
      formData.append('job_id', jobId);

      document.getElementById('progressSection').classList.add('active');
      document.getElementById('processBtn').disabled = true;

      try {
        const response = await fetch('http://localhost:5001/interpolate', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          console.error('Interpolator error response:', text);
          alert('Server error: ' + response.status);
          return;
        }

        let data;
        try {
          data = await response.json();
        } catch (e) {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          alert('Unexpected server response (not JSON).');
          return;
        }

        if (data.success) {
          processedVideoB64 = data.video;
          processedFilename = data.filename;
          document.getElementById('downloadSection').classList.add('active');
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        document.getElementById('processBtn').disabled = false;
      }
    };

    socket.on('upscale_progress', (data) => {
      if (data.job_id === jobId) {
        const fill = document.getElementById('progressFill');
        gsap.to(fill, { width: data.progress + '%', duration: 0.3 });
        document.getElementById('progressText').textContent = data.progress + '%';
        document.getElementById('processingStatus').innerHTML =
          '<strong>üîÑ</strong> ' + data.message;
      }
    });

    // Helper: base64 string -> Blob
    function b64ToBlob(b64Data, contentType = 'video/mp4', sliceSize = 512) {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];

      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }

      return new Blob(byteArrays, { type: contentType });
    }

    document.getElementById('downloadBtn').onclick = () => {
      if (!processedVideoB64) {
        alert('No video data available ‚Äì please run interpolation again.');
        return;
      }

      const blob = b64ToBlob(processedVideoB64, 'video/mp4');
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = processedFilename || 'interpolated.mp4';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      URL.revokeObjectURL(url);
      gsap.from('#downloadBtn', { scale: 1.2, duration: 0.3 });
    };
  </script>
{% endblock %}
